-- Creacion de Tablas Independientes

CREATE TABLE estado(
	id INTEGER generated by default as IDENTITY PRIMARY KEY  NOT NULL ,
	descripcion VARCHAR2(50) NOT NULL
);
INSERT INTO estado(descripcion)
SELECT DISTINCT ESTADO_VICTIMA 
FROM DB_EXCEL
WHERE ESTADO_VICTIMA IS NOT NULL ;
SELECT * FROM estado ORDER BY id; 
DROP TABLE ESTADO;

CREATE TABLE victimas(
	id INTEGER generated by default as IDENTITY PRIMARY KEY  NOT NULL,
	nombre VARCHAR2(50) NOT NULL,
	apellido VARCHAR2(50) NOT NULL,
	direccion VARCHAR2(50) NOT NULL,
	fecha_primera_sospecha DATE NOT NULL,
	fecha_confirmacion DATE NOT NULL,
	fecha_muerte DATE,
	idestado INTEGER NOT NULL,
	FOREIGN KEY (idestado) REFERENCES estado(id)
);
INSERT INTO victimas(nombre,apellido,direccion,fecha_primera_sospecha,fecha_confirmacion,fecha_muerte,idestado)
SELECT DISTINCT DB_EXCEL.NOMBRE_VICTIMA,DB_EXCEL.APELLIDO_VICTIMA,DB_EXCEL.DIRECCION_VICTIMA,
TO_DATE(DB_EXCEL.FECHA_PRIMERA_SOSPECHA,'DD/MM/YYYY HH24:MI'),
TO_DATE(DB_EXCEL.FECHA_CONFIRMACION,'DD/MM/YYYY HH24:MI'),
TO_DATE(DB_EXCEL.FECHA_MUERTE,'DD/MM/YYYY HH24:MI'),
ESTADO.ID
FROM DB_EXCEL 
INNER JOIN ESTADO
	ON DB_EXCEL.ESTADO_VICTIMA = estado.DESCRIPCION 
WHERE NOMBRE_VICTIMA IS NOT NULL AND APELLIDO_VICTIMA IS NOT NULL
AND DIRECCION_VICTIMA IS NOT NULL AND FECHA_PRIMERA_SOSPECHA IS NOT NULL 
AND FECHA_CONFIRMACION IS NOT NULL;
SELECT * FROM VICTIMAS ORDER BY id;
DROP TABLE VICTIMAS;

CREATE TABLE hospitales(
	id INTEGER generated by default as IDENTITY PRIMARY KEY  NOT NULL,
	nombre VARCHAR2(50) NOT NULL,
	direccion VARCHAR2(50) NOT NULL
);
INSERT INTO hospitales(nombre, direccion)
SELECT DISTINCT NOMBRE_HOSPITAL,DIRECCION_HOSPITAL
FROM DB_EXCEL
WHERE NOMBRE_HOSPITAL IS NOT NULL AND DIRECCION_HOSPITAL IS NOT NULL;
SELECT * FROM hospitales ORDER BY id; 
DROP TABLE HOSPITALES;

CREATE TABLE ubicaciones(
	id INTEGER generated by default as IDENTITY PRIMARY KEY  NOT NULL,
	direccion VARCHAR2(50) NOT NULL
);
INSERT INTO ubicaciones(direccion)
SELECT DISTINCT UBICACION_VICTIMA
FROM DB_EXCEL
WHERE UBICACION_VICTIMA IS NOT NULL;
SELECT * FROM ubicaciones ORDER BY id;
DROP TABLE UBICACIONES;

CREATE TABLE tratamientos(
	id INTEGER generated by default as IDENTITY PRIMARY KEY  NOT NULL,
	nombre VARCHAR2(50) NOT NULL,
	efectividad INTEGER NOT NULL
);
INSERT INTO tratamientos(nombre,efectividad)
SELECT DISTINCT TRATAMIENTO,EFECTIVIDAD
FROM DB_EXCEL
WHERE TRATAMIENTO IS NOT NULL AND EFECTIVIDAD IS NOT NULL;
SELECT * FROM tratamientos ORDER BY id; 
DROP TABLE tratamientos;

CREATE TABLE tipos_contacto(
	id INTEGER generated by default as IDENTITY PRIMARY KEY  NOT NULL,
	descripcion VARCHAR2(100) NOT NULL
);
INSERT INTO tipos_contacto(descripcion)
SELECT DISTINCT CONTACTO_FISICO
FROM DB_EXCEL
WHERE CONTACTO_FISICO IS NOT NULL;
SELECT * FROM tipos_contacto ORDER BY id; 
DROP TABLE tipos_contacto;

CREATE TABLE asociados(
	id INTEGER generated by default as IDENTITY PRIMARY KEY  NOT NULL,
	nombre VARCHAR2(50) NOT NULL,
	apellido VARCHAR2(50) NOT NULL
);
INSERT INTO asociados(nombre,apellido)
SELECT DISTINCT NOMBRE_ASOCIADO,APELLIDO_ASOCIADO
FROM DB_EXCEL
WHERE NOMBRE_ASOCIADO IS NOT NULL AND APELLIDO_ASOCIADO IS NOT NULL;
SELECT * FROM asociados ORDER BY id; 
DROP TABLE asociados;

--- CON FORÁNEAS, A EXCEPCION DE VICTIMA

CREATE TABLE reg_victima_hospital(
	id INTEGER generated by default as IDENTITY PRIMARY KEY  NOT NULL,
	idvictima INTEGER NOT NULL,
	idhospital INTEGER NOT NULL,
	FOREIGN KEY (idvictima) REFERENCES victimas(id),
	FOREIGN KEY (idhospital) REFERENCES hospitales(id)
);
INSERT INTO reg_victima_hospital(idvictima,idhospital)
SELECT DISTINCT victimas.ID,hospitales.ID
FROM DB_EXCEL
	INNER JOIN HOSPITALES
	ON DB_EXCEL.NOMBRE_HOSPITAL = HOSPITALES.NOMBRE AND DB_EXCEL.DIRECCION_HOSPITAL = HOSPITALES.DIRECCION 
	INNER JOIN VICTIMAS
	ON DB_EXCEL.NOMBRE_VICTIMA = victimas.nombre AND DB_EXCEL.APELLIDO_VICTIMA =VICTIMAS.APELLIDO; 
SELECT * FROM reg_victima_hospital ORDER BY id;
DROP TABLE REG_VICTIMA_HOSPITAL ;

CREATE TABLE ubicacion_victima(
	id INTEGER generated by default as IDENTITY PRIMARY KEY  NOT NULL,
	fecha_llegada DATE NOT NULL,
	fecha_retiro DATE NOT NULL,
	idvictima INTEGER NOT NULL,
	idubicacion INTEGER NOT NULL,
	FOREIGN KEY (idvictima) REFERENCES victimas(id),
	FOREIGN KEY (idubicacion) REFERENCES ubicaciones(id)
);
INSERT INTO UBICACION_VICTIMA (FECHA_LLEGADA,FECHA_RETIRO,IDVICTIMA,IDUBICACION)
SELECT DISTINCT TO_DATE(DB_EXCEL.FECHA_LLEGADA,'DD/MM/YYYY HH24:MI'),
TO_DATE(DB_EXCEL.FECHA_RETIRO,'DD/MM/YYYY HH24:MI'),
VICTIMAS.ID,UBICACIONES.ID
FROM DB_EXCEL
INNER JOIN VICTIMAS
ON DB_EXCEL.NOMBRE_VICTIMA = VICTIMAS.NOMBRE AND DB_EXCEL.APELLIDO_VICTIMA =VICTIMAS.APELLIDO
INNER JOIN UBICACIONES
ON DB_EXCEL.UBICACION_VICTIMA = UBICACIONES.DIRECCION;
SELECT * FROM ubicacion_victima ORDER BY id; 
DROP TABLE UBICACION_VICTIMA;

CREATE TABLE tratamiento_victima(
	id INTEGER generated by default as IDENTITY PRIMARY KEY  NOT NULL,
	fecha_inicio DATE NOT NULL,
	fecha_fin DATE NOT NULL,
	efectividad_en_victima INTEGER NOT NULL,
	idvictima INTEGER NOT NULL,
	idtratamiento INTEGER NOT NULL,
	FOREIGN KEY (idvictima) REFERENCES victimas(id),
	FOREIGN KEY (idtratamiento) REFERENCES tratamientos(id)
);
INSERT INTO TRATAMIENTO_VICTIMA (FECHA_INICIO,FECHA_FIN,EFECTIVIDAD_EN_VICTIMA,IDVICTIMA,IDTRATAMIENTO)
SELECT DISTINCT TO_DATE(DB_EXCEL.FECHA_INICIO_TRATAMIENTO,'DD/MM/YYYY HH24:MI'),
TO_DATE(DB_EXCEL.FECHA_FIN_TRATAMIENTO,'DD/MM/YYYY HH24:MI'),
DB_EXCEL.EFECTIVIDAD_EN_VICTIMA,
VICTIMAS.ID,TRATAMIENTOS.ID
FROM DB_EXCEL
INNER JOIN VICTIMAS
ON DB_EXCEL.NOMBRE_VICTIMA = VICTIMAS.NOMBRE AND DB_EXCEL.APELLIDO_VICTIMA =VICTIMAS.APELLIDO 
INNER JOIN TRATAMIENTOS
ON DB_EXCEL.TRATAMIENTO = TRATAMIENTOS.NOMBRE
;
SELECT * FROM tratamiento_victima ORDER BY id; 

CREATE TABLE registro_contacto(
	id INTEGER generated by default as IDENTITY PRIMARY KEY  NOT NULL,
	fecha_inicio DATE NOT NULL,
	fecha_fin DATE NOT NULL,
	idcontacto INTEGER NOT NULL,
	idregistro INTEGER NOT NULL,
	FOREIGN KEY (idcontacto) REFERENCES tipos_contacto(id),
	FOREIGN KEY (idregistro) REFERENCES registro_asociado(id)
);
INSERT INTO REGISTRO_CONTACTO (fecha_inicio,FECHA_FIN,IDCONTACTO,IDREGISTRO)
SELECT DISTINCT TO_DATE(FECHA_INICIO_CONTACTO,'DD/MM/YYYY HH24:MI' ), 
TO_DATE(FECHA_FIN_CONTACTO,'DD/MM/YYYY HH24:MI' ),
TIPOS_CONTACTO.ID,
REGISTRO_ASOCIADO.ID
FROM DB_EXCEL
INNER JOIN VICTIMAS
ON VICTIMAS.NOMBRE = DB_EXCEL.NOMBRE_VICTIMA AND VICTIMAS.APELLIDO = DB_EXCEL.APELLIDO_VICTIMA 
INNER JOIN ASOCIADOS
ON ASOCIADOS.NOMBRE = DB_EXCEL.NOMBRE_ASOCIADO AND ASOCIADOS.APELLIDO = DB_EXCEL.APELLIDO_ASOCIADO 
INNER JOIN TIPOS_CONTACTO
ON TIPOS_CONTACTO.DESCRIPCION  = DB_EXCEL.CONTACTO_FISICO 
INNER JOIN REGISTRO_ASOCIADO
ON REGISTRO_ASOCIADO.IDVICTIMA = VICTIMAS.ID AND REGISTRO_ASOCIADO.IDASOCIADO = ASOCIADOS.ID;
SELECT * FROM registro_contacto ORDER BY id; 
DROP TABLE REGISTRO_CONTACTO ;

CREATE TABLE registro_asociado(
	id INTEGER generated by default as IDENTITY PRIMARY KEY  NOT NULL,
	fecha_conocio DATE NOT NULL,
	idasociado INTEGER NOT NULL,
	idvictima INTEGER NOT NULL,
	FOREIGN KEY (idasociado) REFERENCES asociados(id),
	FOREIGN KEY (idvictima) REFERENCES victimas(id)	
);
INSERT INTO REGISTRO_ASOCIADO (FECHA_CONOCIO,IDASOCIADO,IDVICTIMA)
SELECT DISTINCT TO_DATE(DB_EXCEL.FECHA_CONOCIO,'DD/MM/YYYY HH24:MI'),
ASOCIADOS.ID ,VICTIMAS.ID 
FROM DB_EXCEL
INNER JOIN ASOCIADOS
ON DB_EXCEL.NOMBRE_ASOCIADO = ASOCIADOS.NOMBRE AND DB_EXCEL.APELLIDO_ASOCIADO = ASOCIADOS.APELLIDO 
INNER JOIN VICTIMAS
ON DB_EXCEL.NOMBRE_VICTIMA = VICTIMAS.NOMBRE AND DB_EXCEL.APELLIDO_VICTIMA  = VICTIMAS.APELLIDO ;
SELECT * FROM registro_asociado ORDER BY id; 

-- Consullta 1
SELECT HOSPITALES.NOMBRE ,HOSPITALES.DIRECCION ,COUNT(VICTIMAS.FECHA_MUERTE) 
FROM HOSPITALES
INNER JOIN REG_VICTIMA_HOSPITAL
ON HOSPITALES.ID = REG_VICTIMA_HOSPITAL.IDHOSPITAL  
INNER JOIN VICTIMAS 
ON VICTIMAS.ID = REG_VICTIMA_HOSPITAL.IDVICTIMA 
WHERE VICTIMAS.FECHA_MUERTE IS NOT NULL
GROUP BY HOSPITALES.NOMBRE ,HOSPITALES.DIRECCION ;


-- Consulta 2
SELECT VICTIMAS.NOMBRE, VICTIMAS.APELLIDO 
FROM VICTIMAS
INNER JOIN TRATAMIENTO_VICTIMA 
ON TRATAMIENTO_VICTIMA.IDVICTIMA = victimas.ID 
INNER JOIN TRATAMIENTOS
ON TRATAMIENTO_VICTIMA.IDTRATAMIENTO = TRATAMIENTOS.ID 
INNER JOIN ESTADO
ON ESTADO.ID = VICTIMAS.IDESTADO 
WHERE TRATAMIENTOS.NOMBRE = 'Transfusiones de sangre'
AND TRATAMIENTO_VICTIMA.EFECTIVIDAD_EN_VICTIMA > 5
AND ESTADO.DESCRIPCION = 'En cuarentena';


-- Consulta 3
SELECT VICTIMAS.NOMBRE ,VICTIMAS.APELLIDO ,VICTIMAS.DIRECCION,COUNT(REGISTRO_ASOCIADO.ID)
FROM VICTIMAS
INNER JOIN REGISTRO_ASOCIADO
ON REGISTRO_ASOCIADO.IDVICTIMA = VICTIMAS.ID
INNER JOIN ASOCIADOS
ON ASOCIADOS.ID  = REGISTRO_ASOCIADO.IDASOCIADO 
INNER JOIN ESTADO
ON VICTIMAS.IDESTADO = ESTADO.ID 
GROUP BY VICTIMAS.NOMBRE,VICTIMAS.APELLIDO ,VICTIMAS.DIRECCION ,
VICTIMAS.FECHA_MUERTE ,ESTADO.DESCRIPCION 
HAVING COUNT( DISTINCT REGISTRO_ASOCIADO.IDASOCIADO) > 3 
AND (ESTADO.DESCRIPCION = 'Muerte' OR VICTIMAS.FECHA_MUERTE IS NOT NULL)
;


-- Consulta 4
SELECT VICTIMAS.NOMBRE ,VICTIMAS.APELLIDO
FROM VICTIMAS
INNER JOIN REGISTRO_ASOCIADO
ON REGISTRO_ASOCIADO.IDVICTIMA = VICTIMAS.ID 
INNER JOIN REGISTRO_CONTACTO 
ON REGISTRO_CONTACTO.IDREGISTRO = REGISTRO_ASOCIADO.ID 
INNER JOIN TIPOS_CONTACTO
ON TIPOS_CONTACTO.ID = REGISTRO_CONTACTO.IDCONTACTO 
WHERE VICTIMAS.IDESTADO = (SELECT ID FROM ESTADO WHERE DESCRIPCION = 'Suspendida')
AND TIPOS_CONTACTO.DESCRIPCION = 'Beso'
GROUP BY VICTIMAS.NOMBRE ,VICTIMAS.APELLIDO 
HAVING COUNT(DISTINCT REGISTRO_ASOCIADO.IDASOCIADO) > 2;


-- Consulta 5
SELECT VICTIMAS.NOMBRE ,VICTIMAS.APELLIDO ,COUNT(TRATAMIENTOS.ID) AS total
	FROM VICTIMAS
	INNER JOIN TRATAMIENTO_VICTIMA 
	ON TRATAMIENTO_VICTIMA.IDVICTIMA = VICTIMAS.ID 
	INNER JOIN TRATAMIENTOS
	ON TRATAMIENTOS.ID = TRATAMIENTO_VICTIMA.IDTRATAMIENTO 
	WHERE TRATAMIENTOS.NOMBRE  = 'Oxigeno'
	GROUP BY  VICTIMAS.NOMBRE ,VICTIMAS.APELLIDO
	ORDER BY total DESC 
FETCH FIRST 5 ROWS ONLY;

-- Consulta 6
SELECT v.NOMBRE,v.APELLIDO ,v.FECHA_MUERTE 
FROM VICTIMAS v 
INNER JOIN TRATAMIENTO_VICTIMA tv ON 
tv.IDVICTIMA = v.ID
INNER JOIN TRATAMIENTOS t ON
t.ID =tv.IDTRATAMIENTO 
INNER JOIN REG_VICTIMA_HOSPITAL rvh ON 
rvh.IDVICTIMA =v.ID 
INNER JOIN HOSPITALES h ON
h.ID  = rvh.IDHOSPITAL 
WHERE h.DIRECCION = '1987 Delphine Well' 
AND t.NOMBRE  = 'Manejo de la presion arterial'
AND v.FECHA_MUERTE IS NOT NULL 
UNION 
SELECT v.NOMBRE,v.APELLIDO ,v.FECHA_MUERTE 
FROM VICTIMAS v 
INNER JOIN TRATAMIENTO_VICTIMA tv ON 
tv.IDVICTIMA = v.ID
INNER JOIN TRATAMIENTOS t ON
t.ID =tv.IDTRATAMIENTO 
INNER JOIN UBICACION_VICTIMA uv ON 
uv.IDVICTIMA = v.ID 
INNER JOIN UBICACIONES u ON
u.ID = uv.IDUBICACION 
WHERE u.DIRECCION  = '1987 Delphine Well' 
AND t.NOMBRE  = 'Manejo de la presion arterial'
AND v.FECHA_MUERTE IS NOT NULL 
;


--Consulta 7

SELECT v.nombre, v.APELLIDO ,v.DIRECCION 
FROM VICTIMAS v 
where(SELECT COUNT(*) FROM TRATAMIENTO_VICTIMA tv
INNER JOIN TRATAMIENTOS t ON
t.id = tv.IDTRATAMIENTO
WHERE tv.IDVICTIMA = v.ID) = 2;

--Consulta 8
-- Ver datos de la base de datos
SELECT SYS_CONTEXT('USERENV', 'DB_NAME') as "SID", SYS_CONTEXT('USERENV', 'HOST') as "HOSTNAME" FROM DUAL;

SELECT 
    CASE 
        WHEN EXTRACT(MONTH FROM fecha_primera_sospecha) = 1 THEN '1'
        WHEN EXTRACT(MONTH FROM fecha_primera_sospecha) = 2 THEN '2'
        WHEN EXTRACT(MONTH FROM fecha_primera_sospecha) = 3 THEN '3'
        WHEN EXTRACT(MONTH FROM fecha_primera_sospecha) = 4 THEN '4'
        WHEN EXTRACT(MONTH FROM fecha_primera_sospecha) = 5 THEN '5'
        WHEN EXTRACT(MONTH FROM fecha_primera_sospecha) = 6 THEN '6'
        WHEN EXTRACT(MONTH FROM fecha_primera_sospecha) = 7 THEN '7'
        WHEN EXTRACT(MONTH FROM fecha_primera_sospecha) = 8 THEN '8'
        WHEN EXTRACT(MONTH FROM fecha_primera_sospecha) = 9 THEN '9'
        WHEN EXTRACT(MONTH FROM fecha_primera_sospecha) = 10 THEN '10'
        WHEN EXTRACT(MONTH FROM fecha_primera_sospecha) = 11 THEN '11'
        WHEN EXTRACT(MONTH FROM fecha_primera_sospecha) = 12 THEN '12'
    END AS mes_sospecha,
    v.nombre,
    v.apellido,
    COUNT(DISTINCT tv.idtratamiento) AS num_tratamientos
FROM 
    victimas v
    JOIN tratamiento_victima tv ON v.id = tv.idvictima
GROUP BY 
    EXTRACT(MONTH FROM fecha_primera_sospecha),
    v.nombre,
    v.apellido
HAVING 
    COUNT(DISTINCT tv.idtratamiento) = (
        SELECT MAX(num_tratamientos)
        FROM (
            SELECT COUNT(DISTINCT tv2.idtratamiento) AS num_tratamientos
            FROM tratamiento_victima tv2
            GROUP BY tv2.idvictima
        )
    )
    OR COUNT(DISTINCT tv.idtratamiento) = (
        SELECT MIN(num_tratamientos)
        FROM (
            SELECT COUNT(DISTINCT tv3.idtratamiento) AS num_tratamientos
            FROM tratamiento_victima tv3
            GROUP BY tv3.idvictima
        )
    );

   
-- Consulta 8, pero sin mostrar el número, sino que el mes   
SELECT nombre, apellido, COUNT(*) as cantidad_tratamientos
FROM victimas v
JOIN tratamiento_victima tv ON v.id = tv.idvictima
GROUP BY v.id, nombre, apellido
HAVING COUNT(*) = (SELECT MAX(cantidad) FROM (SELECT COUNT(*) as cantidad FROM tratamiento_victima GROUP BY idvictima))
   OR COUNT(*) = (SELECT MIN(cantidad) FROM (SELECT COUNT(*) as cantidad FROM tratamiento_victima GROUP BY idvictima))
ORDER BY cantidad_tratamientos DESC;
   
--Consulta 9
SELECT h.nombre, COUNT(*) as cantidad_victimas, COUNT(*) * 100.0 / SUM(COUNT(*)) OVER() as porcentaje
FROM hospitales h
JOIN reg_victima_hospital rvh ON h.id = rvh.idhospital
JOIN victimas v ON rvh.idvictima = v.id
GROUP BY h.id, h.nombre
ORDER BY porcentaje DESC;

--Consulta 10
SELECT NOMBRE ,DESCRIPCION AS TIPO_CONTACTO,PORCENTAJE_VICTIMAS
FROM (SELECT H.NOMBRE ,TC.DESCRIPCION ,COUNT(*)*100.0/(
		SELECT DISTINCT COUNT(*)
		FROM REGISTRO_ASOCIADO ra 
		INNER JOIN VICTIMAS v ON RA.IDVICTIMA = V.ID 
		INNER JOIN REG_VICTIMA_HOSPITAL rvh ON RVH.IDVICTIMA = V.ID 
		INNER JOIN HOSPITALES ho ON RVH.IDHOSPITAL = ho.ID 
		WHERE H.ID = ho.ID 
	) AS PORCENTAJE_VICTIMAS,
	ROW_NUMBER () OVER (PARTITION BY H.NOMBRE ORDER BY COUNT(*) DESC) AS N
	FROM VICTIMAS v2 
	INNER JOIN REGISTRO_ASOCIADO ra2 ON RA2.IDVICTIMA =V2.ID 
	INNER JOIN REGISTRO_CONTACTO rc ON RC.IDREGISTRO = RA2.ID 
	INNER JOIN TIPOS_CONTACTO tc ON TC.ID = RC.IDCONTACTO 
	INNER JOIN REG_VICTIMA_HOSPITAL rvh2 ON RVH2.IDVICTIMA =V2.ID 
	INNER JOIN HOSPITALES h ON H.ID = RVH2.IDHOSPITAL 
	GROUP BY H.NOMBRE ,TC.DESCRIPCION ,H.ID 
)
WHERE N = 1
ORDER BY PORCENTAJE_VICTIMAS DESC;